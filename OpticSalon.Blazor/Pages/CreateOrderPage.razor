@page "/createOrder/{frameId:int}/{colorId:int}"
@using OpticSalon.Auth.Models
@using OpticSalon.Blazor.Data.Consts
@using OpticSalon.Blazor.Data.Credentials
@using OpticSalon.Blazor.Shared.OrderComponents
@using OpticSalon.Blazor.Services
@using OpticSalon.Domain.FilterData
@using OpticSalon.Domain.Models
@inject IFrameService FrameService
@inject BrowserService BrowserService
@inject IFrameColorService FrameColorService
@inject ILensPackageService LensPackageService
@inject IPurposeService PurposeService
@inject IClientService ClientService
@inject IOrderService OrderService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@attribute [Authorize(Roles = Role.Client)]
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Оформление заказа</PageTitle>

@if (_isLoading)
{
    <MudProgressLinear Color="MudBlazor.Color.Info" Indeterminate="true" Class="m-1" />
    return;
}

@if (_isNotFound)
{
    <MudAlert Class="m-2" Severity="Severity.Normal">Не найдено...</MudAlert>
    return;
}

<MudStack Justify="Justify.Center">
    <MudTabs @bind-ActivePanelIndex="_selectedTabIndex" Centered MinimumTabWidth="20px" Position="Position.Top">
        <MudStack Row Justify="Justify.Center">
            @if (_isButtonsVisible)
            {
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudIconButton Disabled="@(_selectedTabIndex == 0)" OnClick="@(() => ChangeTabIndex(_selectedTabIndex - 1))" 
                    Color="MudBlazor.Color.Secondary" Style="height:50px; width:50px;" Size="Size.Medium" Icon="@Icons.Material.Outlined.ArrowLeft"/>
                </MudStack>
            }
            <MudTabPanel Text="Оправа" Icon="@Icons.Custom.Brands.Awesome">
                <OrderFrameComponent Frame="_createCredentials.Frame" Color="_createCredentials.FrameColor"/>
            </MudTabPanel>
            <MudTabPanel Text="Назначение" Icon="@Icons.Material.Filled.FormatListBulleted">
                <PurposesListComponent Purposes="_recipePurposes" Order="@(_createCredentials)" />
            </MudTabPanel>
            <MudTabPanel Text="Рецепт" Icon="@Icons.Material.Filled.Article" >
                <OrderRecipeComponent Recipe="_createCredentials.Recipe" />
            </MudTabPanel>
            <MudTabPanel Text="Линзы" Icon="@Icons.Material.Outlined.Lens" >
                <OrderLensComponent Packages="_lensPackages" OrderCredentials="_createCredentials"></OrderLensComponent>
            </MudTabPanel>
            <MudTabPanel Text="Доставка" Icon="@Icons.Material.Filled.CardTravel" >
                <OrderDeliveryComponent OrderCredentials="_createCredentials" OnValidSubmit="@(CreateOrder)">
                    <MudButton Style="min-width: 100px;" Variant="Variant.Filled" 
                    Color="MudBlazor.Color.Primary" ButtonType="ButtonType.Submit">Оформить заказ</MudButton>
                </OrderDeliveryComponent>
            </MudTabPanel>
            @if(_isButtonsVisible)
            {
                <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudIconButton Disabled="@(_selectedTabIndex == 4)" OnClick="@(() => ChangeTabIndex(_selectedTabIndex + 1))" 
                        Color="MudBlazor.Color.Secondary" Style="height:50px; width:50px;" Size="Size.Medium" Icon="@Icons.Material.Outlined.ArrowRight"/>
                </MudStack>
            }
        </MudStack>
    </MudTabs>
</MudStack>

@code {
    [Parameter]
    public int FrameId { get; set; }
    [Parameter]
    public int ColorId { get; set; }

    private int _selectedTabIndex = 0;
    private bool _isNotFound;
    private bool _isLoading;
    private bool _isButtonsVisible = true;

    private OrderCreateCredentials _createCredentials = new();
    private List<LensPackage> _lensPackages = new();
    private List<Purpose> _recipePurposes = new();

    private void ChangeTabIndex(int index)
    {
        if (index > 4 || index < 0) return;

        _selectedTabIndex = index;
    }

    private async Task LoadData()
    {
        var frameRes = await FrameService.GetFrameById(FrameId);

        if (!frameRes.Success)
        {
            _isNotFound = true;
            return;
        }

        _createCredentials.Frame = frameRes.Data!;

        var colorRes = await FrameColorService.GetColorById(ColorId);

        if (!colorRes.Success)
        {
            _isNotFound = true;
            return;
        }

        _createCredentials.FrameColor = colorRes.Data!;

        var lensRes = await LensPackageService.GetAllLensPackages();

        if (lensRes.Success)
        {
            _lensPackages = lensRes.Data!;
        }

        var purposeRes = await PurposeService.GetAllPurposes();

        if (purposeRes.Success)
        {
            _recipePurposes = purposeRes.Data!;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async void CreateOrder()
    {
        var res = await OrderService.CreateOrder(_createCredentials.Recipe, _createCredentials.Frame, 
            _createCredentials.FrameColor, _createCredentials.LensPackage, _createCredentials.LensTintingPercent, 
            _createCredentials.ContactPhoneNumber, _createCredentials.DeliveryAddress, _createCredentials.Comment, 
            _createCredentials.Client);

        if (res.Success)
        {
            Snackbar.Add(res.Description, Severity.Info);
            NavManager.NavigateTo("/");
            return;
        }

        Snackbar.Add(res.Description, Severity.Warning);
    }

    protected async override Task OnInitializedAsync()
    {
        _isLoading = true;
        _createCredentials = new OrderCreateCredentials();

        await SetButtonsVisibility();

        await LoadClientInfo();

        await LoadData();

        SetDefaultData();
        _isLoading = false;
    }

    private async Task SetButtonsVisibility()
    {
        var dimensions = await BrowserService.GetDimensions();

        if (dimensions.Width < DeviceConsts.MobileDeviceWidth)
        {
            _isButtonsVisible = false;
            return;
        }

        _isButtonsVisible = true;

        await InvokeAsync(StateHasChanged);
    }

    private void SetDefaultData()
    {
        _createCredentials.Recipe = new Recipe()
        {
            LeftEye = new (),
            RightEye = new (),
            Dp = RecipeDataFilter.GetDpRange().First()
        };

        var purpose = _recipePurposes.FirstOrDefault();

        if (purpose is not null)
        {
            _createCredentials.Recipe.Purpose = purpose;
        }

        var lens = _lensPackages.FirstOrDefault();

        if (lens is not null)
        {
            _createCredentials.LensPackage = lens;
        }

        if (_createCredentials.Client is not null)
        {
            _createCredentials.DeliveryAddress = _createCredentials.Client.Address;
            _createCredentials.ContactPhoneNumber = _createCredentials.Client.PhoneNumber;
        }
    }

    private async Task LoadClientInfo()
    {
        var userIdentity = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

        if (userIdentity is null)
        {
            return;
        }

        var clientId = int.Parse(userIdentity.Claims.First(x => x.Type == UserClaims.ClientId).Value);

        var res = await ClientService.GetClientById(clientId);

        if (res.Success)
        {
            _createCredentials.Client = res.Data!;
        }
    }
}
