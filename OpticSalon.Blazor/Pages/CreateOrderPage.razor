@page "/createOrder/{frameId:int}/{colorId:int}"
@using OpticSalon.Auth.Models
@using OpticSalon.Blazor.Data.Credentials
@using OpticSalon.Blazor.Shared.OrderComponents
@using OpticSalon.Domain.FilterData
@using OpticSalon.Domain.Models
@inject IFrameService FrameService
@inject IFrameColorService FrameColorService
@inject ILensPackageService LensPackageService
@inject IPurposeService PurposeService
@inject IClientService ClientService
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider

@if (_isLoading)
{
    <MudProgressLinear Color="MudBlazor.Color.Info" Indeterminate="true" Class="m-1" />
    return;
}

@if (_isNotFound)
{
    <MudAlert Class="m-2" Severity="Severity.Normal">Не найдено...</MudAlert>
    return;
}

<MudTabs @bind-ActivePanelIndex="_selectedTabIndex" Style="height: 100%" Outlined="true" MinimumTabWidth="20px" Position="Position.Left">
    <MudStack Style="height:100%" Row AlignItems="AlignItems.Center">
        <MudIconButton Disabled="@(_selectedTabIndex == 0)" OnClick="@(() => ChangeTabIndex(_selectedTabIndex - 1))" 
            Color="MudBlazor.Color.Secondary" Style="height:50px;" Size="Size.Medium" Icon="@Icons.Material.Outlined.ArrowLeft"/>
    </MudStack>
        <MudTabPanel Text="Оправа" Icon="@Icons.Custom.Brands.Awesome">
            <OrderFrameComponent Frame="_createCredentials.Frame" Color="_createCredentials.FrameColor"/>
        </MudTabPanel>
        <MudTabPanel Text="Назначение" Icon="@Icons.Material.Filled.FormatListBulleted">
            <PurposesListComponent Purposes="_recipePurposes" SelectedPurpose="_createCredentials.Recipe.Purpose" />
        </MudTabPanel>
        <MudTabPanel Text="Рецепт" Icon="@Icons.Material.Filled.Article" >
            <OrderRecipeComponent Recipe="_createCredentials.Recipe" />
        </MudTabPanel>
        <MudTabPanel Text="Линзы" Icon="@Icons.Material.Outlined.Lens" >
            <OrderLensComponent Packages="_lensPackages" OrderCredentials="_createCredentials"></OrderLensComponent>
        </MudTabPanel>
        <MudTabPanel Text="Доставка" Icon="@Icons.Material.Filled.CardTravel" >
            <OrderDeliveryComponent OrderCredentials="_createCredentials" OnValidSubmit="@(CreateOrder)">
                <MudButton Style="min-width: 100px;" Variant="Variant.Filled" 
                Color="MudBlazor.Color.Primary" ButtonType="ButtonType.Submit">Оформить заказ</MudButton>
            </OrderDeliveryComponent>
        </MudTabPanel>
    <MudStack Style="height:100%" Row AlignItems="AlignItems.Center">
        <MudIconButton Disabled="@(_selectedTabIndex == 4)" OnClick="@(() => ChangeTabIndex(_selectedTabIndex + 1))" 
            Color="MudBlazor.Color.Secondary" Style="height:50px;" Size="Size.Medium" Icon="@Icons.Material.Outlined.ArrowRight"/>
    </MudStack>
</MudTabs>

@code {
    [Parameter]
    public int FrameId { get; set; }
    [Parameter]
    public int ColorId { get; set; }

    private int _selectedTabIndex = 0;
    private bool _isNotFound;
    private bool _isLoading;

    private OrderCreateCredentials _createCredentials = new();
    private List<LensPackage> _lensPackages = new();
    private List<Purpose> _recipePurposes = new();

    private void ChangeTabIndex(int index)
    {
        if (index > 4 || index < 0) return;

        _selectedTabIndex = index;
    }

    private async Task LoadData()
    {
        var frameRes = await FrameService.GetFrameById(FrameId);

        if (!frameRes.Success)
        {
            _isNotFound = true;
            return;
        }

        _createCredentials.Frame = frameRes.Data!;

        var colorRes = await FrameColorService.GetColorById(ColorId);

        if (!colorRes.Success)
        {
            _isNotFound = true;
            return;
        }

        _createCredentials.FrameColor = colorRes.Data!;

        var lensRes = await LensPackageService.GetAllLensPackages();

        if (lensRes.Success)
        {
            _lensPackages = lensRes.Data!;
        }

        var purposeRes = await PurposeService.GetAllPurposes();

        if (purposeRes.Success)
        {
            _recipePurposes = purposeRes.Data!;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async void CreateOrder()
    {

    }

    protected async override Task OnInitializedAsync()
    {
        _isLoading = true;
        _createCredentials = new OrderCreateCredentials();
        await LoadClientInfo();
        SetDefaultData();

        await LoadData();
        _isLoading = false;
    }

    private void SetDefaultData()
    {
        _createCredentials.Recipe = new Recipe()
        {
            LeftEye = new (),
            RightEye = new (),
            Dp = RecipeDataFilter.GetDpRange().First()
        };

        if (_createCredentials.Client is not null)
        {
            _createCredentials.DeliveryAddress = _createCredentials.Client.Address;
            _createCredentials.ContactPhoneNumber = _createCredentials.Client.PhoneNumber;
        }
    }

    private async Task LoadClientInfo()
    {
        var userIdentity = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

        if (userIdentity is null)
        {
            return;
        }

        var clientId = int.Parse(userIdentity.Claims.First(x => x.Type == UserClaims.ClientId).Value);

        var res = await ClientService.GetClientById(clientId);

        if (res.Success)
        {
            _createCredentials.Client = res.Data!;
        }
    }
}
