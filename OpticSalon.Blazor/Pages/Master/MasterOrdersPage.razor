@page "/masterOrders"

@using OpticSalon.Auth.Models
@using OpticSalon.Blazor.Data.Consts
@using OpticSalon.Blazor.Services
@using OpticSalon.Blazor.Shared.Dialogs
@using OpticSalon.Domain.Enums
@using OpticSalon.Domain.Extensions
@using OpticSalon.Domain.Models
@using OpticSalon.Domain.ResultModels

@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider
@inject IEmployeeService EmployeeService
@inject IOrderService OrderService
@inject IWarrantyRepairService RepairService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject BrowserService BrowserService

@attribute [Authorize(Roles = Role.Master)]

<PageTitle>Заказы</PageTitle>

@if (_isLoading)
{
    <MudProgressLinear Color="MudBlazor.Color.Info" Indeterminate="true" Class="m-1" />
    return;
}

<MudPaper Class="w-100 p-2">
    <MudGrid Class="w-100 ms-2 p-2">
        <MudStack Row AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Medium" Color="MudBlazor.Color.Secondary"></MudIcon>
            <MudText Typo="Typo.h6" Color="MudBlazor.Color.Secondary">Заказы</MudText>
        </MudStack>
        <MudSpacer />
        <MudDateRangePicker MaxDate="DateTime.Now" @ref="_picker" Margin="Margin.Dense" @bind-DateRange="_period" Label="Период" DateFormat="dd MMMM, yyyy" TitleDateFormat="MMMM dd">
            <PickerActions>
                <MudButton Color="MudBlazor.Color.Primary" OnClick="@(async () => await PeriodChanged())">Выбрать</MudButton>
            </PickerActions>
        </MudDateRangePicker>
        <MudSpacer/>
        <MudTextField ValueChanged="@((text) => SearchTextChanged(text))" Style="@(_isSmallDevice ? "min-width: 250px;" : "min-width: 350px;")" T="string" Placeholder="Поиск" 
            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" 
            IconSize="Size.Medium" Class="mt-0 mb-2 me-1"></MudTextField>
    </MudGrid>
</MudPaper>

<MudDropContainer T="MasterOrder" @ref="_dropContainer" ItemDropped="ItemUpdated" Items="@_filterOrders" Style="min-height:78vh;"
    ItemsSelector="@((item,column) => item.OrderStatus.GetDisplayName() == column)" 
    Class="d-flex flex-rotop-row flex-wrap m-1">
    <ChildContent>
        <MudItem xs="12" sm="6" md="3">
            <MudDropZone T="MasterOrder" Identifier="@OrderStatus.Created.GetDisplayName()" 
                Class="mud-height-full rounded-lg mud-alert-text-error pa-3 ma-3 border-1">
                <MudGrid>
                    <MudIcon Size="Size.Small" Class="ma-2" Icon="@Icons.Material.Filled.Create"></MudIcon>
                    <MudText Typo="Typo.button" Class="ma-2">@OrderStatus.Created.GetDisplayName()</MudText>
                    <MudSpacer/>
                    <MudText Typo="Typo.button" Class="ma-2">@GetOrdersCountByStatus(OrderStatus.Created)</MudText>
                </MudGrid>
            </MudDropZone>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDropZone T="MasterOrder" Identifier="@OrderStatus.InWork.GetDisplayName()" 
                Class="mud-height-full rounded-lg mud-alert-text-warning pa-3 ma-3 border-1">
                <MudGrid>
                    <MudIcon Size="Size.Small" Class="ma-2" Icon="@Icons.Material.Filled.AccessTime"></MudIcon>
                    <MudText Typo="Typo.button" Class="ma-2">@OrderStatus.InWork.GetDisplayName()</MudText>
                    <MudSpacer/>
                    <MudText Typo="Typo.button" Class="ma-2">@GetOrdersCountByStatus(OrderStatus.InWork)</MudText>
                </MudGrid>
            </MudDropZone>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDropZone T="MasterOrder" Identifier="@OrderStatus.Completed.GetDisplayName()" 
                Class="mud-height-full rounded-lg mud-alert-text-info pa-3 ma-3 border-1">
               <MudGrid>
                    <MudIcon Size="Size.Small" Class="ma-2" Icon="@Icons.Material.Filled.CardTravel"></MudIcon>
                    <MudText Typo="Typo.button" Class="ma-2">@OrderStatus.Completed.GetDisplayName()</MudText>
                    <MudSpacer/>
                    <MudText Typo="Typo.button" Class="ma-2">@GetOrdersCountByStatus(OrderStatus.Completed)</MudText>
                </MudGrid>
            </MudDropZone>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="mud-height-full rounded-lg ma-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h5" Color="MudBlazor.Color.Secondary">Статистика по заказам</MudText>
                </MudCardHeader>
                <MudCardContent Class="d-flex align-center justify-center">
                    <MudChart ChartType="ChartType.Donut" Width="@(_isSmallDevice ? "200px" : "300px")" Height="@(_isSmallDevice ? "200px" : "300px")" InputData="@_data" InputLabels="@_labels">
	                    <CustomGraphics>
		                    <text class="donut-inner-text" x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="3">Всего</text>
		                    <text class="donut-inner-text" x="50%" y="57%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="5">@_data.Sum().ToString()</text>
	                    </CustomGraphics>
                    </MudChart>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </ChildContent>
    <ItemRenderer>
		<MudPaper onclick="@(() => ShowOrder(context))" Elevation="25" Class="pa-4 rounded-lg my-3">
            <MudText Typo="Typo.body1" Class="mb-1">
                <MudIcon Size="Size.Small" Class="m-0" Icon="@GetListItemIcon(context.OrderType)"/> @GetListItemTitle(context)
            </MudText>
            <MudText Typo="Typo.body1">Дата создания: @context.CreatedDate.ToShortDateString()</MudText>
        </MudPaper>
	</ItemRenderer>
</MudDropContainer>

@code {
    private MudDropContainer<MasterOrder> _dropContainer;
    private int _masterId;
    private bool _isLoading;
    private string _search = "";
    private List<MasterOrder> _allOrders = new();
    private List<MasterOrder> _filterOrders = new();

    public double[] _data => GetChartData();
    public string[] _labels = new string[0];
    private bool _isSmallDevice;

    private DateRange _period = new DateRange()
    {
        Start = DateTime.Today.AddDays(-7),
        End = DateTime.Today
    };
    private MudDateRangePicker _picker = null;

    protected async override Task OnInitializedAsync()
    {
        await SetDevice();
        _isLoading = true;
        await LoadMasterInfo();
        await LoadMasterOrders();
        _isLoading = false;
    }

    private int GetOrdersCountByStatus(OrderStatus status)
    {
        return _filterOrders.Where(x => x.OrderStatus == status).Count();
    }

    private async Task LoadMasterInfo()
    {
        var userIdentity = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

        if (userIdentity is null)
        {
            return;
        }

        _masterId = int.Parse(userIdentity.Claims.First(x => x.Type == UserClaims.EmployeeId).Value);
    }

    private async Task LoadMasterOrders()
    {
        if (_masterId == 0)
        {
            return;
        }

        var result = await EmployeeService.GetMasterOrdersAsync(_masterId, _period.Start ?? DateTime.Now, _period.End ?? DateTime.Now);

        if (result.Success)
        {
            _allOrders = result.Data!;
            Search();
        }
    }

    private async Task ItemUpdated(MudItemDropInfo<MasterOrder> dropItem)
    {
        var dropStatus = dropItem.DropzoneIdentifier.GetValueFromName<OrderStatus>();

        if (dropItem.Item.OrderStatus == OrderStatus.Issued || dropStatus == OrderStatus.Issued)
        {
            return;
        }

        var parameters = new DialogParameters
        {
            { "Question", "Вы точно желаете поменять статус заказа?" }
        };

        var dialog = await DialogService.ShowAsync<QuestionDialog>("Изменение статуса", parameters);
        var result = await dialog.Result;

        if (result.Canceled)
        {
            return;
        }

        if (dropItem.Item.OrderType == OrderType.ManufactureOrder)
        {
            var orderRes = await OrderService.GetOrderById(dropItem.Item.OrderID);

            if (!orderRes.Success)
            {
                Snackbar.Add("Произошла ошибка...", Severity.Warning);
                return;
            }

            var order = orderRes.Data!;
            order.Status = dropStatus;

            var updateResult = await OrderService.UpdateOrder(order);

            if (!updateResult.Success)
            {
                Snackbar.Add("Произошла ошибка...", Severity.Warning);
                return;
            }
        }
        else
        {
            var repairRes = await RepairService.GetRepairById(dropItem.Item.OrderID);

            if (!repairRes.Success)
            {
                Snackbar.Add("Произошла ошибка...", Severity.Warning);
                return;
            }

            var repair = repairRes.Data!;
            repair.Status = dropStatus;

            var updateResult = await RepairService.UpdateRepair(repair);

            if (!updateResult.Success)
            {
                Snackbar.Add("Произошла ошибка...", Severity.Warning);
                return;
            }
        }

        dropItem.Item.OrderStatus = dropStatus;
    }

    private void ShowOrder(MasterOrder order)
    {
        if (order.OrderType == OrderType.ManufactureOrder)
        {
            NavManager.NavigateTo($"/orderShow/{order.OrderID}");
        }
        else
        {
            NavManager.NavigateTo($"/warrantyRepair/{order.OrderID}");
        }
    }

    private void SearchTextChanged(string text)
    {
        _search = text.ToLower();

        Search();
    }

    private void Search()
    {
        if (string.IsNullOrWhiteSpace(_search))
        {
            _filterOrders = _allOrders;
            return;
        }

        _filterOrders = _allOrders
                .Where(x => x.OrderID.ToString().ToLower().Contains(_search)
                || x.OrderType.GetDisplayName()!.ToLower().Contains(_search)).ToList();
    }

    private string GetListItemIcon(OrderType type)
    {
        if (type == OrderType.ManufactureOrder) return Icons.Material.Filled.Assignment;

        return Icons.Material.Filled.Construction;
    }

    private string GetListItemTitle(MasterOrder order)
    {
        if (order.OrderType == OrderType.ManufactureOrder) return $"Заказ №{order.OrderID}";

        return $"Гарантийный ремонт №{order.OrderID}";
    }

    private async Task SetDevice()
    {
        var dimensions = await BrowserService.GetDimensions();

        if (dimensions.Width < DeviceConsts.SmallDeviceWidth)
        {
            _isSmallDevice = true;
            return;
        }
    }

    private double[] GetChartData()
    {
        List<double> result = new();
        List<string> labels = new();

        foreach(var status in Enum.GetValues(typeof(OrderStatus)).Cast<OrderStatus>())
        {
            var count = _allOrders.Where(x => x.OrderStatus == status).Count();

            labels.Add(status.GetDisplayName() + $" - {count}");
            result.Add(Convert.ToDouble(count));
        }

        _labels = labels.ToArray();

        return result.ToArray();
    }

    private async Task PeriodChanged()
    {
        _picker.Close();
        await LoadMasterOrders();
    }
}
