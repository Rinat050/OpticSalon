@page "/clientProfile"

@using Microsoft.AspNetCore.Identity
@using OpticSalon.Auth.Managers
@using OpticSalon.Auth.Models
@using OpticSalon.Blazor.Data.Credentials
@using OpticSalon.Blazor.Middleware
@using OpticSalon.Domain.Models

@attribute [Authorize(Roles = Role.Client)]
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider;
@inject OpticSalonSignInManager SignInManager
@inject UserManager<OpticSalonUser> UserManager
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@inject IClientService ClientService
@inject IOrderService OrderService

<PageTitle>Профиль</PageTitle>

@if (_isLoading)
{
    <MudProgressLinear Color="MudBlazor.Color.Info" Indeterminate="true" Class="m-1" />
    return;
}

@if (_client == null)
{
    <MudAlert Class="m-2" Severity="Severity.Normal">Не найдено...</MudAlert>
    return;
}

<MudContainer Style="min-height: 90vh;" Class="d-flex justify-center mud-width-full" >
    <MudCard Class="mt-2 mb-2 p-1 w-100" Style="border-radius: 20px;"
             Outlined Elevation="3">
        <MudCardHeader>
            <MudGrid Class="m-2">
                <MudAvatar Style="width: 100px; height:100px;" Class="m-1" Color="MudBlazor.Color.Primary">
                    <MudText Class="m-5" Typo="Typo.h4">@GetAvatarText()</MudText>
                    </MudAvatar>
                <MudStack Class="ms-4" Justify="Justify.Center">
                    <MudText Color="MudBlazor.Color.Secondary" Typo="Typo.h5" Class="m-0 p-0">@_client?.Name @_client?.Surname</MudText>
                    <MudText Color="MudBlazor.Color.Secondary" Typo="Typo.h6" Class="m-0 p-0">@_user?.Email</MudText>
                </MudStack>
            </MudGrid>
        </MudCardHeader>
        <MudCardContent>
            <MudTabs PanelClass="pa-6" MinimumTabWidth="20px" Position="Position.Top">
                <MudTabPanel Text="Личные данные">
                    <ClientProfileDataComponent Client="_client" OnValidSubmit="@(LoadClientInfo)"></ClientProfileDataComponent>
                </MudTabPanel>
                <MudTabPanel Text="Предпочтения">
                    <ProfileClientPreferencesComponent ClientId="_client.Id" ClientPreferences="_clientPreferences" />
                </MudTabPanel>
                <MudTabPanel Text="Заказы">
                    <ClientOrdersComponent Orders="_orders"></ClientOrdersComponent>
                </MudTabPanel>
            </MudTabs>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private OpticSalonUser _user = new();
    private Client _client = null!;
    private ClientPreferences _clientPreferences = null!;
    private List<OrderShort> _orders = new(); 
    private bool _isLoading;

    protected async override Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;

        await LoadClientInfo();

        if (_client == null) return;

        var preferencesRes = await ClientService.GetClientPreferences(_client.Id);

        if (preferencesRes.Success)
        {
            _clientPreferences = preferencesRes.Data!;
        }

        var ordersRes = await OrderService.GetOrdersByClient(_client.Id);

        if (ordersRes.Success)
        {
            _orders = ordersRes.Data!;
        }

        _isLoading = false;
    }

    private async Task LoadClientInfo()
    {
        var userIdentity = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;

        if (userIdentity is null)
        {
            return;
        }

        var clientId = int.Parse(userIdentity.Claims.First(x => x.Type == UserClaims.ClientId).Value);

        _user = await UserManager.FindByEmailAsync(userIdentity.Identity?.Name);

        var res = await ClientService.GetClientById(clientId);

        if (res.Success)
        {
            _client = res.Data!;
        }

        await InvokeAsync(StateHasChanged);
    }

    private string GetAvatarText()
    {
        return $"{_client?.Name[0]}{_client?.Surname[0]}";
    }
}